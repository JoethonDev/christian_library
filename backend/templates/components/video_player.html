<!-- templates/components/video_player.html -->
{% load i18n %}
{% if video.videometa %}
    <div class="mb-3" style="text-align:right;">
        {% if available_qualities and available_qualities|length > 1 %}
            <form id="quality-form" hx-get="{% url 'frontend_api:video_player' video.id %}" hx-target="#video-player-container" hx-swap="outerHTML" style="display:inline;">
                <label for="quality-select" class="me-2 fw-bold">{% trans "Quality:" %}</label>
                <select id="quality-select" name="quality" class="form-select d-inline-block w-auto" onchange="this.form.submit()">
                    <option value="auto" {% if selected_quality == 'auto' %}selected{% endif %}>{% trans "Auto" %}</option>
                    {% for q in available_qualities %}
                        <option value="{{ q }}" {% if selected_quality == q %}selected{% endif %}>{{ q|upper }}</option>
                    {% endfor %}
                </select>
            </form>
        {% endif %}
    </div>
    <div id="video-player-container">
        <div style="position:relative; width:100%; padding-top:56.25%; background:#000; border-radius:1rem; overflow:hidden;">
            <video id="video-{{ video.id }}" controls preload="metadata"
                   style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; background:#000; border-radius:1rem;">
                {% if hls_playlist %}
                    <!-- HLS streaming source (correct MIME type) -->
                    <source src="{% url 'core_utils:secure_stream' file_path=hls_playlist %}" type="application/vnd.apple.mpegurl">
                {% elif video.videometa.original_file %}
                    <!-- Fallback to original file only if HLS is not available -->
                    <source src="{% url 'core_utils:secure_stream' file_path=video.videometa.original_file %}" type="video/mp4">
                    <source src="{% url 'core_utils:secure_stream' file_path=video.videometa.original_file %}" type="video/webm">
                {% endif %}
                {% trans "Your browser does not support the video element." %}
            </video>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('video-{{ video.id }}');
        const videoSrc = video.querySelector('source[type="application/vnd.apple.mpegurl"]');
        if (videoSrc && typeof Hls !== 'undefined') {
            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                    maxBufferLength: 300,
                    maxMaxBufferLength: 600,
                    manifestLoadingTimeOut: 20000,
                    manifestLoadingMaxRetry: 3,
                    manifestLoadingRetryDelay: 1000,
                    levelLoadingTimeOut: 20000,
                    levelLoadingMaxRetry: 3,
                    levelLoadingRetryDelay: 1000,
                    fragLoadingTimeOut: 20000,
                    fragLoadingMaxRetry: 3,
                    fragLoadingRetryDelay: 1000,
                    startLevel: -1,
                    abrEwmaDefaultEstimate: 500000
                });
                hls.loadSource(videoSrc.src);
                hls.attachMedia(video);
                
                // Add error handling to prevent excessive retries
                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.warn('HLS network error, attempting recovery...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.warn('HLS media error, attempting recovery...');
                                hls.recoverMediaError();
                                break;
                            default:
                                console.error('HLS fatal error:', data);
                                hls.destroy();
                                break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoSrc.src;
            }
        }
    });
    </script>
{% else %}
    <div class="ratio ratio-16x9 w-100 d-flex align-items-center justify-content-center" style="background: #f8f9fa; min-height:60vh;">
        <div class="text-center w-100">
            <div class="mb-3">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            </div>
            <h6 class="text-muted mb-2">{% trans "Video file not available" %}</h6>
            <p class="text-muted small mb-0">{% trans "This video has not been uploaded yet" %}</p>
        </div>
    </div>
{% endif %}