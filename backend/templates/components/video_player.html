<!-- templates/components/video_player.html -->
{% load i18n %}
{% if video.videometa %}
    <div id="video-player-container">
        <div style="position:relative; border-radius:1rem; overflow:hidden; background:#000;">
            <!-- Quality Selector Overlay -->
            {% if available_qualities and available_qualities|length > 1 %}
                <div style="position:absolute; top:10px; right:10px; z-index:1000;">
                    <form id="quality-form" hx-get="{% url 'frontend_api:video_player' video.id %}" hx-target="#video-player-container" hx-swap="outerHTML" style="display:inline;">
                        <select id="quality-select" name="quality" class="form-select form-select-sm" 
                                style="background: rgba(0,0,0,0.85); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 0.8rem; min-width: 70px; padding: 2px 6px;">
                            <option value="auto" {% if selected_quality == 'auto' %}selected{% endif %}>{% trans "Auto" %}</option>
                            {% for q in available_qualities %}
                                <option value="{{ q }}" {% if selected_quality == q %}selected{% endif %}>{{ q|upper }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            {% endif %}
            
            <video id="video-{{ video.id }}" controls preload="metadata" 
                   style="width:100%; max-width:100%; height:auto; display:block; border-radius:1rem;"
                   poster="{% if video.videometa.thumbnail %}{{ video.videometa.thumbnail.url }}{% endif %}">
                {% if hls_playlist %}
                    <!-- HLS streaming source (correct MIME type) -->
                    <source src="{% url 'core_utils:secure_stream' file_path=hls_playlist %}" type="application/vnd.apple.mpegurl">
                {% elif video.videometa.original_file %}
                    <!-- Fallback to original file only if HLS is not available -->
                    <source src="{% url 'core_utils:secure_stream' file_path=video.videometa.original_file %}" type="video/mp4">
                    <source src="{% url 'core_utils:secure_stream' file_path=video.videometa.original_file %}" type="video/webm">
                {% endif %}
                {% trans "Your browser does not support the video element." %}
            </video>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('video-{{ video.id }}');
        const videoSrc = video.querySelector('source[type="application/vnd.apple.mpegurl"]');
        const qualityForm = document.getElementById('quality-form');
        const qualitySelect = document.getElementById('quality-select');
        
        // Debug logging for quality selection
        console.log('Video player loaded:', {
            selectedQuality: '{{ selected_quality }}',
            availableQualities: {{ available_qualities|default:"[]"|safe }},
            hlsPlaylist: '{{ hls_playlist }}'
        });
        
        // Prevent form submission navigation and ensure HTMX handles it
        if (qualityForm && qualitySelect) {
            qualitySelect.addEventListener('change', function(e) {
                e.preventDefault();
                console.log('Quality changed to:', this.value);
                
                // Trigger HTMX request manually to ensure correct targeting
                const url = qualityForm.getAttribute('hx-get') + '?quality=' + encodeURIComponent(this.value);
                console.log('Requesting quality change:', url);
                
                htmx.ajax('GET', url, {
                    target: '#video-player-container',
                    swap: 'outerHTML'
                });
                
                return false;
            });
        }
        
        if (videoSrc && typeof Hls !== 'undefined') {
            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                    maxBufferLength: 300,
                    maxMaxBufferLength: 600,
                    manifestLoadingTimeOut: 20000,
                    manifestLoadingMaxRetry: 3,
                    manifestLoadingRetryDelay: 1000,
                    levelLoadingTimeOut: 20000,
                    levelLoadingMaxRetry: 3,
                    levelLoadingRetryDelay: 1000,
                    fragLoadingTimeOut: 20000,
                    fragLoadingMaxRetry: 3,
                    fragLoadingRetryDelay: 1000,
                    startLevel: -1,
                    abrEwmaDefaultEstimate: 500000
                });
                
                console.log('Loading HLS source:', videoSrc.src);
                hls.loadSource(videoSrc.src);
                hls.attachMedia(video);
                
                // Log when levels are loaded
                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    console.log('HLS manifest loaded, levels:', data.levels.map(l => l.height + 'p'));
                });
                
                // Add error handling to prevent excessive retries
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.warn('HLS network error, attempting recovery...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.warn('HLS media error, attempting recovery...');
                                hls.recoverMediaError();
                                break;
                            default:
                                console.error('HLS fatal error:', data);
                                hls.destroy();
                                break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                console.log('Using native HLS support');
                video.src = videoSrc.src;
            }
        } else {
            console.log('HLS not available, using direct video source');
        }
    });
    </script>
    
    <style>
    /* Quality selector styling */
    #quality-select {
        transition: all 0.2s ease;
        backdrop-filter: blur(8px);
        border-radius: 6px !important;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    #quality-select:hover {
        background: rgba(0,0,0,0.95) !important;
        border-color: rgba(255,255,255,0.5) !important;
        transform: scale(1.02);
    }
    
    #quality-select:focus {
        background: rgba(0,0,0,0.95) !important;
        border-color: #87CEEB !important;
        box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.3) !important;
        outline: none;
    }
    
    #quality-select option {
        background: #222;
        color: white;
        padding: 4px;
    }
    </style>
{% else %}
    <div class="ratio ratio-16x9 w-100 d-flex align-items-center justify-content-center" style="background: #f8f9fa; min-height:60vh;">
        <div class="text-center w-100">
            <div class="mb-3">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            </div>
            <h6 class="text-muted mb-2">{% trans "Video file not available" %}</h6>
            <p class="text-muted small mb-0">{% trans "This video has not been uploaded yet" %}</p>
        </div>
    </div>
{% endif %}