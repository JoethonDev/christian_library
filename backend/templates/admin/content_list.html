<!-- templates/admin/content_list.html - Modern Content Management -->
{% extends "layouts/admin_base.html" %}
{% load i18n %}

{% block admin_content %}
{% csrf_token %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h1 class="h3 fw-bold text-dark mb-1">{% trans "Content Management" %}</h1>
        <p class="text-muted mb-0">{% trans "Manage your library's videos, audio messages, and documents" %}</p>
    </div>
    <div class="col-auto d-flex gap-2">
        <button id="bulk-generate-ai" class="btn btn-outline-primary rounded-pill px-4" style="display:none;">
            <i class="bi bi-magic me-2"></i>{% trans "Generate with AI" %}
        </button>
        <a href="{% url 'frontend_api:upload_content' %}" class="btn btn-primary text-white rounded-pill px-4 shadow-sm">
            <i class="bi bi-plus-lg me-2"></i>{% trans "Upload" %}
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="card-body p-4">
        <!-- Search and Filter Section -->
        <div class="row g-3 align-items-center mb-4">
            <div class="col-lg-8">
                <form hx-get="{% url 'frontend_api:admin_content_list' %}" 
                      hx-target="#admin-content-table" 
                      hx-trigger="change, keyup delay:300ms from:input"
                      class="d-flex gap-2 flex-column flex-md-row">
                    
                    <div class="position-relative flex-grow-1">
                        <span class="position-absolute top-50 start-0 translate-middle-y ms-3 text-muted">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="search" name="q" class="form-control rounded-pill ps-5 bg-light border-0" 
                               placeholder="{% trans 'Search content by title, description, or ID...' %}" 
                               value="{{ search_query }}">
                    </div>
                    
                    <select name="type" class="form-select rounded-pill bg-light border-0" style="width: auto; min-width: 150px;">
                        <option value="">{% trans "All Types" %}</option>
                        {% for type_code, type_name in content_types %}
                            <option value="{{ type_code }}" {% if content_type_filter == type_code %}selected{% endif %}>
                                {{ type_name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="col-lg-4 text-end">
                <div class="btn-group">
                    <button class="btn btn-light rounded-pill px-3" onclick="window.print()" title="{% trans 'Print' %}">
                        <i class="bi bi-printer"></i>
                    </button>
                    <!-- Future Export Feature -->
                    <!-- <button class="btn btn-light rounded-pill px-3 ms-2" title="{% trans 'Export' %}">
                        <i class="bi bi-download"></i>
                    </button> -->
                </div>
            </div>
        </div>

        <!-- Content Table Component -->
        <div id="admin-content-table" class="table-responsive">
            {% include "admin/partials/content_list.html" %}
        </div>
    </div>
</div>

<script>
// Multi-selection for batch AI generation
document.addEventListener('DOMContentLoaded', function() {
    const bulkBtn = document.getElementById('bulk-generate-ai');
    
    // Update bulk button visibility based on selection
    function updateBulkButton() {
        const selected = document.querySelectorAll('input[name="content_select"]:checked').length;
        if (selected > 0) {
            bulkBtn.style.display = 'block';
            bulkBtn.innerHTML = `<i class="bi bi-magic me-2"></i>{% trans "Generate AI for" %} ${selected} {% trans "items" %}`;
        } else {
            bulkBtn.style.display = 'none';
        }
    }
    
    // Listen for checkbox changes
    document.addEventListener('change', function(e) {
        if (e.target.name === 'content_select' || e.target.id === 'select-all') {
            updateBulkButton();
        }
    });
    
    // Handle select all
    document.addEventListener('change', function(e) {
        if (e.target.id === 'select-all') {
            document.querySelectorAll('input[name="content_select"]').forEach(cb => {
                cb.checked = e.target.checked;
            });
            updateBulkButton();
        }
    });
    
    // Bulk AI generation
    bulkBtn.addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('input[name="content_select"]:checked'))
            .map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            return;
        }
        
        // Direct action without confirmation
        showToast('{% trans "Generating metadata with AI..." %}', 'info');
        
        // Build FormData with multiple content_ids parameters
        const formData = new FormData();
        formData.append('action', 'generate_seo');
        selectedIds.forEach(id => {
            formData.append('content_ids', id);
        });
        
        fetch('{% url "frontend_api:bulk_seo_actions_api" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || data.messages) {
                showToast(`{% trans "Queued AI generation for" %} ${data.success || selectedIds.length} {% trans "items" %}`, 'success');
                // Uncheck all
                document.querySelectorAll('input[name="content_select"]').forEach(cb => cb.checked = false);
                document.getElementById('select-all').checked = false;
                updateBulkButton();
            } else {
                showToast(data.error || '{% trans "Failed to queue AI generation" %}', 'danger');
            }
        })
        .catch(err => {
            showToast('{% trans "An error occurred while queueing AI generation" %}', 'danger');
            console.error(err);
        });
    });
});
</script>
{% endblock %}