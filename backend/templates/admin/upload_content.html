<!-- templates/admin/upload_content.html -->
{% extends "layouts/admin_base.html" %}
{% load i18n %}

{% block admin_content %}
<div class="row align-items-center mb-4">
    <div class="col">
        <h1 class="h3 fw-bold text-dark mb-1">{% trans "Upload Content" %}</h1>
        <p class="text-muted mb-0">{% trans "Add new videos, audio, or documents to the library" %}</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-12 col-xl-10">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
                <form id="upload-form" method="post" enctype="multipart/form-data" action="{% url 'frontend_api:handle_upload' %}">
                    {% csrf_token %}

                    <!-- Progress Bar -->
                    <div id="progress-container" class="mb-4 d-none">
                        <div class="progress" style="height: 10px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="progress-status" class="small mt-2 text-center text-muted fw-bold"></div>
                    </div>

                    <!-- Type Selection -->
                    <div class="mb-5">
                        <label class="form-label fw-bold text-uppercase small text-secondary mb-3 d-block text-center">
                            {% trans "Select Content Type" %}
                        </label>
                        
                        <div class="row justify-content-center g-3">
                            <div class="col-6 col-md-3">
                                <input type="radio" class="btn-check" name="content_type" id="video-type" value="video" autocomplete="off">
                                <label class="btn btn-outline-light text-dark border w-100 p-3 h-100 d-flex flex-column align-items-center rounded-3 shadow-sm hover-shadow" for="video-type">
                                    <i class="bi bi-camera-video fs-1 text-primary mb-2"></i>
                                    <span class="fw-semibold">{% trans "Video" %}</span>
                                    <small class="text-muted d-none d-md-block mt-1">{% trans "MP4, AVI, MOV" %}</small>
                                </label>
                            </div>
                            
                            <div class="col-6 col-md-3">
                                <input type="radio" class="btn-check" name="content_type" id="audio-type" value="audio" autocomplete="off">
                                <label class="btn btn-outline-light text-dark border w-100 p-3 h-100 d-flex flex-column align-items-center rounded-3 shadow-sm hover-shadow" for="audio-type">
                                    <i class="bi bi-mic fs-1 text-primary mb-2"></i>
                                    <span class="fw-semibold">{% trans "Audio" %}</span>
                                    <small class="text-muted d-none d-md-block mt-1">{% trans "MP3, WAV" %}</small>
                                </label>
                            </div>
                            
                            <div class="col-6 col-md-3">
                                <input type="radio" class="btn-check" name="content_type" id="pdf-type" value="pdf" autocomplete="off">
                                <label class="btn btn-outline-light text-dark border w-100 p-3 h-100 d-flex flex-column align-items-center rounded-3 shadow-sm hover-shadow" for="pdf-type">
                                    <i class="bi bi-file-earmark-pdf fs-1 text-primary mb-2"></i>
                                    <span class="fw-semibold">{% trans "Document" %}</span>
                                    <small class="text-muted d-none d-md-block mt-1">{% trans "PDF" %}</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Zone -->
                    <div class="mb-5">
                        <div class="upload-zone text-center p-5 rounded-4 border-2 border-dashed bg-light" 
                             style="cursor: pointer; border-color: var(--bs-border-color);"
                             onclick="document.getElementById('file-input').click()">
                            <input type="file" id="file-input" name="file" class="d-none" required onchange="updateFileName(this)">
                            
                            <div class="mb-3">
                                <div class="d-inline-flex align-items-center justify-content-center bg-white rounded-circle shadow-sm p-4">
                                    <i class="bi bi-cloud-arrow-up fs-1 text-primary"></i>
                                </div>
                            </div>
                            
                            <h5 class="fw-bold mb-2">{% trans "Click to upload or drag and drop" %}</h5>
                            <p class="text-muted mb-3">{% trans "Max file size: Video (2GB), Audio (100MB), PDF (50MB)" %}</p>
                            
                            <div id="file-name-display" class="d-none mt-3">
                                <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2 fs-6">
                                    <i class="bi bi-file-earmark-check me-2"></i><span id="selected-file-name"></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Details Section -->
                    <div class="mb-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label fw-bold text-uppercase small text-secondary mb-0">{% trans "Content Information" %}</label>
                            <button type="button" class="btn btn-sm btn-outline-primary rounded-pill" onclick="generateMetadataAndSEO()">
                                <i class="bi bi-magic me-1"></i>{% trans "Generate with AI" %}
                                <span class="spinner-border spinner-border-sm d-none ms-1" id="magic-spinner"></span>
                            </button>
                        </div>
                        
                        <div class="row g-4">
                            <!-- Arabic -->
                            <div class="col-md-6">
                                <div class="p-3 bg-white border rounded-3 h-100 shadow-sm">
                                    <div class="d-flex align-items-center mb-3 text-primary">
                                        <i class="bi bi-translate me-2"></i>
                                        <span class="fw-semibold">{% trans "Arabic Details" %}</span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">{% trans "Title" %}</label>
                                        <input type="text" name="title_ar" class="form-control" required dir="rtl">
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label small text-muted">{% trans "Description" %}</label>
                                        <textarea name="description_ar" class="form-control" rows="3" dir="rtl"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- English -->
                            <div class="col-md-6">
                                <div class="p-3 bg-white border rounded-3 h-100 shadow-sm">
                                    <div class="d-flex align-items-center mb-3 text-secondary">
                                        <i class="bi bi-globe me-2"></i>
                                        <span class="fw-semibold">{% trans "English Details" %}</span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">{% trans "Title" %}</label>
                                        <input type="text" name="title_en" class="form-control" dir="ltr">
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label small text-muted">{% trans "Description" %}</label>
                                        <textarea name="description_en" class="form-control" rows="3" dir="ltr"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tags -->
                            <div class="col-12">
                                <label class="form-label small text-muted">{% trans "Tags" %} ({% trans "Comma Separated" %})</label>
                                <input type="text" name="tags" class="form-control" placeholder="hymns, liturgy, st. george...">
                            </div>
                        </div>
                    </div>

                    <!-- SEO (Collapsed) -->
                    <div class="accordion mb-5 shadow-sm rounded-3 overflow-hidden" id="seoAccordion">
                        <div class="accordion-item border-0">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-white fw-semibold text-dark" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSEO">
                                    <i class="bi bi-search me-2"></i>{% trans "SEO Configuration" %} <span class="text-muted fw-normal ms-2 small">({% trans "Optional" %})</span>
                                </button>
                            </h2>
                            <div id="collapseSEO" class="accordion-collapse collapse" data-bs-parent="#seoAccordion">
                                <div class="accordion-body bg-light p-4">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label small text-muted">{% trans "Meta Title (EN)" %}</label>
                                            <input type="text" name="seo_title_en" class="form-control form-control-sm">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small text-muted">{% trans "Meta Title (AR)" %}</label>
                                            <input type="text" name="seo_title_ar" class="form-control form-control-sm" dir="rtl">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small text-muted">{% trans "Meta Description (EN)" %}</label>
                                            <textarea name="seo_description_en" class="form-control form-control-sm" rows="2"></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small text-muted">{% trans "Meta Description (AR)" %}</label>
                                            <textarea name="seo_description_ar" class="form-control form-control-sm" rows="2" dir="rtl"></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small text-muted">{% trans "Focus Keywords (EN)" %}</label>
                                            <input type="text" name="seo_keywords_en" class="form-control form-control-sm" placeholder="keyword1, keyword2">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small text-muted">{% trans "Focus Keywords (AR)" %}</label>
                                            <input type="text" name="seo_keywords_ar" class="form-control form-control-sm" dir="rtl" placeholder="كلمة1, كلمة2">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small text-muted d-flex justify-content-between">
                                                {% trans "Structured Data (JSON-LD)" %}
                                                <span class="badge bg-info-subtle text-info">{% trans "Schema.org" %}</span>
                                            </label>
                                            <textarea name="seo_structured_data" id="seo_structured_data" class="form-control form-control-sm font-monospace" rows="4" placeholder='{ "@context": "https://schema.org", "@type": "VideoObject", ... }'></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                        <a href="{% url 'frontend_api:admin_dashboard' %}" class="btn btn-light rounded-pill px-4">{% trans "Cancel" %}</a>
                        <button type="submit" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm">
                            <i class="bi bi-cloud-upload me-2"></i>{% trans "Upload Content" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-shadow:hover {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        border-color: var(--bs-primary)!important;
    }
    .btn-check:checked + .btn {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        border-color: var(--bs-primary);
        color: var(--bs-primary) !important;
    }
    .btn-check:checked + .btn i {
        color: var(--bs-primary) !important;
    }
</style>

<script>
    // Dual-request workflow for parallel metadata and SEO generation
    function generateMetadataAndSEO() {
        const fileInput = document.getElementById('file-input');
        if (!fileInput.files || !fileInput.files[0]) {
            showToast('{% trans "Please select a file first" %}', 'warning');
            return;
        }

        const spinner = document.getElementById('magic-spinner');
        spinner.classList.remove('d-none');
        
        const contentType = document.querySelector('input[name="content_type"]:checked')?.value || '';
        
        // Create FormData for metadata request
        const metadataFormData = new FormData();
        metadataFormData.append('file', fileInput.files[0]);
        metadataFormData.append('content_type', contentType);
        
        // Create FormData for SEO request
        const seoFormData = new FormData();
        seoFormData.append('file', fileInput.files[0]);
        seoFormData.append('content_type', contentType);
        
        // Track completion status
        let metadataCompleted = false;
        let seoCompleted = false;
        
        // Parallel request 1: Generate metadata
        fetch('{% url "frontend_api:generate_metadata_only" %}', {
            method: 'POST',
            body: metadataFormData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            metadataCompleted = true;
            if (data.success && data.metadata) {
                // Populate metadata fields using standardized JSON format
                const meta = data.metadata;
                
                // English metadata
                if (meta.en && meta.en.title) {
                    document.querySelector('input[name="title_en"]').value = meta.en.title;
                }
                if (meta.en && meta.en.description) {
                    document.querySelector('textarea[name="description_en"]').value = meta.en.description;
                }
                
                // Arabic metadata
                if (meta.ar && meta.ar.title) {
                    document.querySelector('input[name="title_ar"]').value = meta.ar.title;
                }
                if (meta.ar && meta.ar.description) {
                    document.querySelector('textarea[name="description_ar"]').value = meta.ar.description;
                }
                
                showToast('{% trans "Metadata generated successfully!" %}', 'success');
            } else {
                showToast(data.error || '{% trans "Failed to generate metadata" %}', 'danger');
            }
            
            // Hide spinner if both requests are complete
            if (seoCompleted) {
                spinner.classList.add('d-none');
            }
        })
        .catch(error => {
            metadataCompleted = true;
            console.error('Metadata generation error:', error);
            showToast('{% trans "An error occurred while generating metadata" %}', 'danger');
            if (seoCompleted) {
                spinner.classList.add('d-none');
            }
        });
        
        // Parallel request 2: Generate SEO
        fetch('{% url "frontend_api:generate_seo_only" %}', {
            method: 'POST',
            body: seoFormData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            seoCompleted = true;
            if (data.success && data.seo) {
                // Populate SEO fields using standardized JSON format
                const seo = data.seo;
                
                // English SEO
                if (seo.en && seo.en.meta_title) {
                    document.querySelector('input[name="seo_title_en"]').value = seo.en.meta_title;
                }
                if (seo.en && seo.en.description) {
                    document.querySelector('textarea[name="seo_description_en"]').value = seo.en.description;
                }
                if (seo.en && seo.en.keywords && Array.isArray(seo.en.keywords)) {
                    document.querySelector('input[name="seo_keywords_en"]').value = seo.en.keywords.join(', ');
                }
                
                // Arabic SEO
                if (seo.ar && seo.ar.meta_title) {
                    document.querySelector('input[name="seo_title_ar"]').value = seo.ar.meta_title;
                }
                if (seo.ar && seo.ar.description) {
                    document.querySelector('textarea[name="seo_description_ar"]').value = seo.ar.description;
                }
                if (seo.ar && seo.ar.keywords && Array.isArray(seo.ar.keywords)) {
                    document.querySelector('input[name="seo_keywords_ar"]').value = seo.ar.keywords.join(', ');
                }
                
                showToast('{% trans "SEO metadata generated successfully!" %}', 'success');
            } else {
                showToast(data.error || '{% trans "Failed to generate SEO metadata" %}', 'danger');
            }
            
            // Hide spinner if both requests are complete
            if (metadataCompleted) {
                spinner.classList.add('d-none');
            }
        })
        .catch(error => {
            seoCompleted = true;
            console.error('SEO generation error:', error);
            showToast('{% trans "An error occurred while generating SEO metadata" %}', 'danger');
            if (metadataCompleted) {
                spinner.classList.add('d-none');
            }
        });
    }
    
    // Keep backward compatibility with old function name
    function generateMetadata() {
        generateMetadataAndSEO();
    }

    function updateFileName(input) {
        const displayContainer = document.getElementById('file-name-display');
        const nameSpan = document.getElementById('selected-file-name');
        
        if (input.files && input.files[0]) {
            nameSpan.textContent = input.files[0].name;
            displayContainer.classList.remove('d-none');
            
            // Auto Select Type Attempt
            const ext = input.files[0].name.split('.').pop().toLowerCase();
            if(['mp4','avi','mov'].includes(ext)) document.getElementById('video-type').click();
            if(['mp3','wav'].includes(ext)) document.getElementById('audio-type').click();
            if(['pdf'].includes(ext)) document.getElementById('pdf-type').click();
        } else {
            displayContainer.classList.add('d-none');
        }
    }
    
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = this;
        const submitBtn = form.querySelector('button[type="submit"]');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        
        progressContainer.classList.remove('d-none');
        submitBtn.disabled = true;
        
        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressStatus.textContent = percent + '% ' + '{% trans "uploaded" %}';
            }
        });
        
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    progressStatus.textContent = '{% trans "Upload complete! Redirecting..." %}';
                    showToast('{% trans "Upload successful!" %}', 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "frontend_api:admin_dashboard" %}';
                    }, 1000);
                } else {
                    showToast(response.error || '{% trans "Upload failed" %}', 'danger');
                    submitBtn.disabled = false;
                    progressContainer.classList.add('d-none');
                }
            } else {
                showToast('{% trans "An error occurred during upload" %}', 'danger');
                submitBtn.disabled = false;
                progressContainer.classList.add('d-none');
            }
        });
        
        xhr.addEventListener('error', function() {
            showToast('{% trans "Network error during upload" %}', 'danger');
            submitBtn.disabled = false;
            progressContainer.classList.add('d-none');
        });
        
        xhr.open('POST', form.action, true);
        xhr.send(formData);
    });
</script>
{% endblock %}
