<!-- templates/admin/pdf_management.html - Modern PDF Management -->
{% extends "layouts/admin_base.html" %}
{% load i18n %}

{% block admin_content %}
<div class="container-fluid px-0">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-dark mb-1">{% trans "PDF Manager" %}</h1>
            <p class="text-muted mb-0">{% trans "Manage books, documents, and sacred texts" %}</p>
        </div>
        <a href="{% url 'frontend_api:upload_content' %}?type=pdf" class="btn btn-primary rounded-pill px-4">
            <i class="bi bi-plus-lg me-2"></i>{% trans "Add PDF" %}
        </a>
    </div>

    <!-- Filter Bar -->
    <div class="card border-0 shadow-sm rounded-4 mb-3">
        <div class="card-body">
            <form method="GET" class="row g-2 align-items-center"
                  hx-get="{% url 'frontend_api:pdf_management' %}"
                  hx-target="#pdf-table-container"
                  hx-swap="innerHTML"
                  hx-trigger="submit, change from:select, keyup delay:500ms from:input[name='search']">
                <div class="col-md-5">
                    <input type="text" name="search" class="form-control" placeholder="{% trans 'Search in titles, descriptions, and content...' %}" value="{{ filters.search }}">
                </div>
                <div class="col-md-3">
                    <select name="status" class="form-select">
                        <option value="">{% trans "All Status" %}</option>
                        <option value="active" {% if filters.status == 'active' %}selected{% endif %}>{% trans "Active" %}</option>
                        <option value="inactive" {% if filters.status == 'inactive' %}selected{% endif %}>{% trans "Inactive" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="missing_data" class="form-select">
                        <option value="">{% trans "All Data" %}</option>
                        <option value="no_seo" {% if filters.missing_data == 'no_seo' %}selected{% endif %}>{% trans "Missing SEO" %}</option>
                        <option value="no_metadata" {% if filters.missing_data == 'no_metadata' %}selected{% endif %}>{% trans "Missing Metadata" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel me-1"></i>{% trans "Filter" %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="card border-0 shadow-sm rounded-4 mb-3" id="bulkActionsBar" style="display: none;">
        <div class="card-body py-2">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span class="text-muted me-3">
                        <i class="bi bi-check-circle me-1"></i>
                        <span id="selectedCount">0</span> {% trans "selected" %}
                    </span>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-warning text-white" onclick="bulkGenerateSEO()">
                        <i class="bi bi-sparkles me-1"></i>{% trans "Generate SEO" %}
                    </button>
                    <button type="button" class="btn btn-sm btn-success" onclick="bulkActivate()">
                        <i class="bi bi-eye me-1"></i>{% trans "Activate" %}
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="bulkDeactivate()">
                        <i class="bi bi-eye-slash me-1"></i>{% trans "Deactivate" %}
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="bulkDelete()">
                        <i class="bi bi-trash me-1"></i>{% trans "Delete" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Table Card -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden" id="pdf-table-container">
        {% include "admin/partials/pdf_table.html" %}
    </div>
</div>

<script>
// Bulk Selection Functions
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkActions();
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    const count = checkboxes.length;
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (count > 0) {
        bulkBar.style.display = 'block';
        selectedCount.textContent = count;
    } else {
        bulkBar.style.display = 'none';
    }
    
    // Update master checkbox state
    const allCheckboxes = document.querySelectorAll('.row-checkbox');
    const masterCheckbox = document.getElementById('selectAll');
    if (masterCheckbox) {
        masterCheckbox.checked = count === allCheckboxes.length && count > 0;
        masterCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
    }
}

function getSelectedIds() {
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.dataset.contentId);
}

// Bulk Actions
function bulkGenerateSEO() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('{% trans "Please select at least one PDF" %}', 'warning');
        return;
    }
    
    const message = '{% trans "Generate SEO metadata for selected PDFs?" %}';
    const details = `<strong>{% trans "Selected items:" %}</strong> ${selectedIds.length}<br>` +
                   `{% trans "This will use AI to generate SEO metadata for all selected PDFs." %}`;
    
    showConfirmation(message, details, function() {
        performBulkAction('{% url "frontend_api:api_auto_fill_metadata" %}', selectedIds);
    });
}

function bulkActivate() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('{% trans "Please select at least one PDF" %}', 'warning');
        return;
    }
    
    const message = '{% trans "Activate selected PDFs?" %}';
    const details = `<strong>{% trans "Selected items:" %}</strong> ${selectedIds.length}`;
    
    showConfirmation(message, details, function() {
        performBulkToggleStatus(selectedIds, true);
    });
}

function bulkDeactivate() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('{% trans "Please select at least one PDF" %}', 'warning');
        return;
    }
    
    const message = '{% trans "Deactivate selected PDFs?" %}';
    const details = `<strong>{% trans "Selected items:" %}</strong> ${selectedIds.length}`;
    
    showConfirmation(message, details, function() {
        performBulkToggleStatus(selectedIds, false);
    });
}

function bulkDelete() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showToast('{% trans "Please select at least one PDF" %}', 'warning');
        return;
    }
    
    const message = '{% trans "Delete selected PDFs?" %}';
    const details = `<strong class="text-danger">{% trans "WARNING:" %}</strong> ` +
                   `{% trans "This will permanently delete" %} ${selectedIds.length} {% trans "PDF(s)." %}<br>` +
                   `{% trans "This action cannot be undone!" %}`;
    
    showConfirmation(message, details, function() {
        performBulkDelete(selectedIds);
    });
}

// Perform Bulk Actions
function refreshTable() {
    const filterForm = document.querySelector('form[hx-get]');
    if (filterForm) {
        // Trigger HTMX request by dispatching submit event
        filterForm.dispatchEvent(new Event('submit', { cancelable: true }));
        
        // Reset check-all and bulk bar
        setTimeout(() => {
            const masterCheckbox = document.getElementById('selectAll');
            if (masterCheckbox) {
                masterCheckbox.checked = false;
                masterCheckbox.indeterminate = false;
            }
            const bulkBar = document.getElementById('bulkActionsBar');
            if (bulkBar) bulkBar.style.display = 'none';
        }, 100);
    } else {
        window.location.reload();
    }
}

function performBulkAction(url, contentIds) {
    const data = { content_ids: contentIds };
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || '{% trans "Action completed successfully" %}', 'success');
            refreshTable();
        } else {
            showToast(data.error || '{% trans "Action failed" %}', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('{% trans "An error occurred" %}', 'danger');
    });
}

function performBulkToggleStatus(contentIds, status) {
    fetch('{% url "frontend_api:api_toggle_content_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            content_ids: contentIds,
            is_active: status,
            bulk: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || '{% trans "Status updated successfully" %}', 'success');
            refreshTable();
        } else {
            showToast(data.error || '{% trans "Failed to update status" %}', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('{% trans "An error occurred" %}', 'danger');
    });
}

function performBulkDelete(contentIds) {
    fetch('{% url "frontend_api:bulk_operations" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'operation': 'delete',
            'content_ids': contentIds.join(',')
        })
    })
    .then(response => {
        if (response.ok) {
            showToast('{% trans "PDFs deleted successfully" %}', 'success');
            refreshTable();
        } else {
            showToast('{% trans "Failed to delete PDFs" %}', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('{% trans "An error occurred" %}', 'danger');
    });
}

// Single Item Actions
function confirmAutoFill(contentId, title) {
    const message = '{% trans "Generate SEO metadata for this PDF?" %}';
    const details = `<strong>{% trans "PDF:" %}</strong> ${title}<br>` +
                   `{% trans "This will use AI to generate SEO metadata." %}`;
    
    showConfirmation(message, details, function() {
        autoFillMetadata(contentId);
    });
}

function toggleStatus(contentId, checkbox) {
    checkbox.disabled = true;
    
    fetch('{% url "frontend_api:api_toggle_content_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            content_id: contentId,
            is_active: checkbox.checked
        })
    })
    .then(response => response.json())
    .then(data => {
        checkbox.disabled = false;
        if (data.success) {
            showToast(data.is_active ? '{% trans "Content activated" %}' : '{% trans "Content hidden" %}', 'success');
        } else {
            checkbox.checked = !checkbox.checked;
            showToast(data.error || '{% trans "Failed to update status" %}', 'danger');
        }
    })
    .catch(error => {
        checkbox.disabled = false;
        checkbox.checked = !checkbox.checked;
        console.error('Error:', error);
        showToast('{% trans "An error occurred" %}', 'danger');
    });
}

function autoFillMetadata(contentId) {
    fetch('{% url "frontend_api:api_auto_fill_metadata" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            content_id: contentId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('{% trans "Auto-fill started! Processing in background..." %}', 'success');
            // Refresh table after a delay to show updated status
            setTimeout(() => refreshTable(), 2000);
        } else {
            showToast(data.error || '{% trans "Failed to start auto-fill" %}', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('{% trans "An error occurred" %}', 'danger');
    });
}
</script>
{% endblock %}