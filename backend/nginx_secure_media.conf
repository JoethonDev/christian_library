# Nginx configuration for secure media serving with X-Accel-Redirect
# Add this to your existing nginx server block

server {
    # ... your existing configuration ...
    
    # Regular Django application
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Important: Remove any X-Accel-Redirect headers from client
        proxy_set_header X-Accel-Redirect "";
    }
    
    # Internal location for secure media serving
    # This path should never be accessible directly from outside
    location /internal/media/ {
        internal;  # This makes the location only accessible via X-Accel-Redirect
        
        # Remove /internal prefix and serve from actual media directory
        rewrite ^/internal/media/(.*)$ /$1 break;
        
        # Set the root to your media directory
        root /path/to/your/media/directory;
        
        # Set appropriate headers for media files
        add_header Cache-Control "public, max-age=3600";
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "SAMEORIGIN";
        
        # Enable efficient file serving
        sendfile on;
        sendfile_max_chunk 1m;
        
        # Enable range requests for video/audio streaming
        proxy_max_temp_file_size 0;
        
        # MIME type handling
        location ~* \.(mp4|avi|mov|wmv|flv|webm)$ {
            add_header Accept-Ranges bytes;
            add_header Cache-Control "public, max-age=7200";
        }
        
        location ~* \.(mp3|wav|ogg|m4a|aac|flac)$ {
            add_header Accept-Ranges bytes;
            add_header Cache-Control "public, max-age=7200";
        }
        
        location ~* \.(pdf|doc|docx)$ {
            add_header Cache-Control "public, max-age=86400";
            add_header Content-Disposition "inline";
        }
    }
    
    # Direct public media access (for non-secure files like thumbnails)
    location /media/public/ {
        root /path/to/your;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }
    
    # Block direct access to all other media files
    location /media/ {
        deny all;
        return 403;
    }
    
    # Static files (CSS, JS, images)
    location /static/ {
        root /path/to/your;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        gzip_static on;
    }
    
    # ... rest of your configuration ...
}

# Rate limiting for media access
limit_req_zone $binary_remote_addr zone=media:10m rate=10r/m;

# Apply rate limiting to secure media endpoints
# Downloads are public, streaming requires auth
location /core/media/secure/ {
    # Public downloads - no rate limiting needed
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location /core/media/stream/ {
    # Authenticated streaming with rate limiting
    limit_req zone=media burst=5 nodelay;
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}